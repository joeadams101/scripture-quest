<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Scripture Quest">
  <meta name="theme-color" content="#000000">
  <title>Scripture Quest</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *{-webkit-tap-highlight-color:transparent;box-sizing:border-box}
    body{margin:0;font-family:system-ui,sans-serif;background:#000;overflow-x:hidden}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    @keyframes glow{0%,100%{box-shadow:0 0 20px rgba(251,191,36,.4)}50%{box-shadow:0 0 40px rgba(251,191,36,.7)}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes scaleIn{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
    @keyframes hit{0%{transform:scale(1)}50%{transform:scale(1.1);filter:brightness(2)}100%{transform:scale(1)}}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes dmgFloat{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-50px)}}
    .aF{animation:float 3s ease-in-out infinite}
    .aP{animation:pulse 2s ease-in-out infinite}
    .aG{animation:glow 2s ease-in-out infinite}
    .aS{animation:spin 1s linear infinite}
    .aFI{animation:fadeIn .5s ease-out forwards}
    .aSI{animation:scaleIn .3s ease-out forwards}
    .aSH{animation:shimmer 2s linear infinite;background-size:200% 100%}
    .aShake{animation:shake .3s ease-in-out}
    .aHit{animation:hit .3s ease-out}
    .aSlide{animation:slideIn .3s ease-out}
    .aDmg{animation:dmgFloat 1s ease-out forwards}
    .btn{background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;font-weight:700;padding:16px 32px;border-radius:16px;border:none;font-size:18px;cursor:pointer;width:100%;transition:transform .1s}
    .btn:active{transform:scale(.96)}.btn:disabled{opacity:.4;transform:none}
    .btn2{background:rgba(255,255,255,.1);color:#fff;font-weight:600;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);cursor:pointer;width:100%}
    .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px}
    .glow-legendary{box-shadow:0 0 20px rgba(251,191,36,.5),inset 0 0 20px rgba(251,191,36,.1)}
    .glow-epic{box-shadow:0 0 15px rgba(139,92,246,.5),inset 0 0 15px rgba(139,92,246,.1)}
    .glow-rare{box-shadow:0 0 10px rgba(59,130,246,.4),inset 0 0 10px rgba(59,130,246,.1)}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useCallback,useRef}=React;

// =============== GAME DATA ===============
const CLASSES=[
  {id:"prophet",name:"Prophet",icon:"üî•",char:"üßô‚Äç‚ôÇÔ∏è",bonus:"+25% XP OT",stats:{atk:12,def:8,hp:100,crit:10,spd:10},ability:{name:"Holy Fire",desc:"Deal 2x damage",cooldown:4}},
  {id:"evangelist",name:"Evangelist",icon:"üìñ",char:"üßë‚Äçü¶±",bonus:"+25% XP Gospels",stats:{atk:10,def:10,hp:110,crit:8,spd:12},ability:{name:"Healing Word",desc:"Restore 30 HP",cooldown:3}},
  {id:"psalmist",name:"Psalmist",icon:"üéµ",char:"üë®‚Äçü¶∞",bonus:"+25% XP Psalms",stats:{atk:8,def:12,hp:120,crit:5,spd:8},ability:{name:"Shield of Faith",desc:"Block next attack",cooldown:3}},
  {id:"apostle",name:"Apostle",icon:"‚úâÔ∏è",char:"üßî",bonus:"+25% XP Epistles",stats:{atk:14,def:6,hp:90,crit:15,spd:14},ability:{name:"Righteous Strike",desc:"Guaranteed crit",cooldown:5}}
];

const ENEMIES={
  serpent:{name:"The Serpent",emoji:"üêç",hp:60,atk:8,def:2,xp:30,gold:15,pattern:["attack","poison","attack"]},
  guards:{name:"Egyptian Guards",emoji:"‚öîÔ∏è",hp:80,atk:12,def:5,xp:50,gold:25,pattern:["attack","attack","defend"]},
  pharaoh:{name:"Pharaoh",emoji:"üëë",hp:150,atk:18,def:10,xp:100,gold:50,pattern:["attack","summon","attack","rage"],boss:true},
  lion:{name:"Hungry Lion",emoji:"ü¶Å",hp:70,atk:15,def:3,xp:40,gold:20,pattern:["attack","pounce"]},
  goliath:{name:"Goliath",emoji:"üëπ",hp:200,atk:25,def:15,xp:150,gold:80,pattern:["taunt","attack","smash","attack"],boss:true},
  legion:{name:"Legion",emoji:"üëª",hp:100,atk:10,def:0,xp:60,gold:35,pattern:["swarm","attack","swarm"]}
};

const CHAPTERS={
  "gen-1":{book:"Genesis",ch:1,title:"Creation",region:"creation",enemy:"serpent",
    verses:["In the beginning God created the heaven and the earth.","And God said, Let there be light: and there was light.","And God saw the light, that it was good.","And God called the light Day, and the darkness Night."],
    quiz:[{q:"What did God create first?",a:["Heaven and earth","Light","Man","Animals"],c:0},{q:"What did God call the light?",a:["Sun","Day","Morning","Bright"],c:1},{q:"How did God create light?",a:["With his hands","By speaking","With fire","By thinking"],c:1}]},
  "gen-2":{book:"Genesis",ch:2,title:"Garden of Eden",region:"creation",enemy:"serpent",
    verses:["On the seventh day God rested.","God blessed the seventh day.","The LORD formed man from dust.","He breathed life into man's nostrils."],
    quiz:[{q:"What did God do on day seven?",a:["Created man","Rested","Made animals","Planted garden"],c:1},{q:"Man was formed from?",a:["Water","Dust","Light","Clay"],c:1}]},
  "gen-3":{book:"Genesis",ch:3,title:"The Fall",region:"creation",enemy:"serpent",boss:true,
    verses:["The serpent was cunning.","He deceived the woman.","She ate the forbidden fruit.","Their eyes were opened."],
    quiz:[{q:"Who tempted Eve?",a:["Lion","Serpent","Eagle","Adam"],c:1},{q:"What happened after eating?",a:["Nothing","Eyes opened","They died","They flew"],c:1},{q:"What fruit was forbidden?",a:["Apple","Tree of Knowledge","Fig","Grape"],c:1}]},
  "exo-1":{book:"Exodus",ch:1,title:"Slavery in Egypt",region:"exodus",enemy:"guards",
    verses:["Israel multiplied in Egypt.","A new Pharaoh arose.","He feared the Israelites.","He made them slaves."],
    quiz:[{q:"Where were Israelites enslaved?",a:["Canaan","Egypt","Babylon","Rome"],c:1},{q:"Why did Pharaoh fear Israel?",a:["Their gods","Their numbers","Their weapons","Their magic"],c:1}]},
  "exo-14":{book:"Exodus",ch:14,title:"Red Sea",region:"exodus",enemy:"pharaoh",boss:true,
    verses:["Pharaoh's army pursued Israel.","Moses stretched his hand.","The sea parted.","Israel crossed on dry ground."],
    quiz:[{q:"Who parted the sea?",a:["Aaron","Moses","Joshua","God through Moses"],c:3},{q:"How did Israel cross?",a:["Swimming","Boats","Dry ground","Flying"],c:2},{q:"What happened to Egypt's army?",a:["Escaped","Drowned","Surrendered","Won"],c:1}]}
};

const REGIONS=[
  {id:"creation",name:"Creation",icon:"üåç",chapters:["gen-1","gen-2","gen-3"],unlockLvl:1},
  {id:"exodus",name:"Exodus",icon:"üî•",chapters:["exo-1","exo-14"],unlockLvl:5},
  {id:"kingdom",name:"Kingdom",icon:"üëë",chapters:[],unlockLvl:15},
  {id:"prophets",name:"Prophets",icon:"üìú",chapters:[],unlockLvl:25}
];

const COMPANIONS=[
  {id:"ruth",name:"Ruth",emoji:"üåæ",rarity:"Rare",bonus:"+10% Gold",stats:{atk:3,def:2,hp:20},ability:{name:"Loyalty",desc:"+15% DEF for 3 turns",type:"buff"}},
  {id:"samuel",name:"Samuel",emoji:"üì¢",rarity:"Rare",bonus:"+10% XP",stats:{atk:4,def:1,hp:15},ability:{name:"Prophecy",desc:"See enemy next move",type:"reveal"}},
  {id:"esther",name:"Esther",emoji:"üë∏",rarity:"Rare",bonus:"+5% All",stats:{atk:2,def:3,hp:25},ability:{name:"Royal Favor",desc:"Heal 20 HP",type:"heal"}},
  {id:"peter",name:"Peter",emoji:"ü™®",rarity:"Epic",bonus:"+15% XP",stats:{atk:6,def:4,hp:30},ability:{name:"Rock Solid",desc:"Block 1 attack",type:"shield"}},
  {id:"daniel",name:"Daniel",emoji:"ü¶Å",rarity:"Epic",bonus:"+1 Base Life",stats:{atk:5,def:5,hp:35},ability:{name:"Lion's Den",desc:"Stun enemy 1 turn",type:"stun"}},
  {id:"elijah",name:"Elijah",emoji:"üî•",rarity:"Epic",bonus:"+20% XP",stats:{atk:8,def:2,hp:25},ability:{name:"Fire from Heaven",desc:"Deal 40 damage",type:"damage"}},
  {id:"moses",name:"Moses",emoji:"‚ö°",rarity:"Legendary",bonus:"+30% XP",stats:{atk:10,def:6,hp:40},ability:{name:"Part the Sea",desc:"Skip enemy turn",type:"skip"}},
  {id:"david",name:"David",emoji:"üëë",rarity:"Legendary",bonus:"+25% All",stats:{atk:12,def:4,hp:35},ability:{name:"Giant Slayer",desc:"Deal 3x damage to bosses",type:"bossDmg"}}
];

const GEAR=[
  {id:"staff0",name:"Walking Stick",icon:"ü™µ",slot:"weapon",rarity:"Common",stats:{atk:2},desc:"+2 ATK"},
  {id:"robe0",name:"Simple Robe",icon:"üëò",slot:"armor",rarity:"Common",stats:{def:2,hp:10},desc:"+2 DEF +10 HP"},
  {id:"sandals0",name:"Worn Sandals",icon:"üë°",slot:"boots",rarity:"Common",stats:{spd:2},desc:"+2 SPD"},
  {id:"staff1",name:"Shepherd's Rod",icon:"ü™ù",slot:"weapon",rarity:"Rare",stats:{atk:5,crit:5},desc:"+5 ATK +5% CRIT"},
  {id:"shield1",name:"Bronze Shield",icon:"üõ°Ô∏è",slot:"armor",rarity:"Rare",stats:{def:6,hp:25},desc:"+6 DEF +25 HP"},
  {id:"boots1",name:"Swift Sandals",icon:"üëü",slot:"boots",rarity:"Rare",stats:{spd:5,crit:3},desc:"+5 SPD +3% CRIT"},
  {id:"staff2",name:"Prophet's Staff",icon:"üîÆ",slot:"weapon",rarity:"Epic",stats:{atk:10,crit:8},desc:"+10 ATK +8% CRIT"},
  {id:"armor2",name:"Priestly Vestments",icon:"‚öúÔ∏è",slot:"armor",rarity:"Epic",stats:{def:10,hp:40},desc:"+10 DEF +40 HP"},
  {id:"boots2",name:"Winged Sandals",icon:"ü™Ω",slot:"boots",rarity:"Epic",stats:{spd:8,crit:5},desc:"+8 SPD +5% CRIT"},
  {id:"staff3",name:"Staff of Moses",icon:"‚ö°",slot:"weapon",rarity:"Legendary",stats:{atk:18,crit:12},desc:"+18 ATK +12% CRIT"},
  {id:"armor3",name:"Armor of God",icon:"‚öîÔ∏è",slot:"armor",rarity:"Legendary",stats:{def:15,hp:60,atk:5},desc:"+15 DEF +60 HP +5 ATK"},
  {id:"boots3",name:"Gospel Boots",icon:"‚ú®",slot:"boots",rarity:"Legendary",stats:{spd:12,crit:8,def:3},desc:"+12 SPD +8% CRIT +3 DEF"}
];

const TOWER_EVENTS=["battle","battle","battle","elite","treasure","rest","shop"];

const SHOP=[
  {id:"energy",name:"Energy Refill",icon:"‚ö°",desc:"Restore 5 energy",price:100,type:"energy"},
  {id:"ticket",name:"Summon Ticket",icon:"üéüÔ∏è",desc:"1 companion pull",price:500,type:"ticket"},
  {id:"potion",name:"Health Potion",icon:"üß™",desc:"Heal 50 HP in battle",price:75,type:"item",itemId:"potion"},
  {id:"revive",name:"Phoenix Down",icon:"ü™∂",desc:"Revive once per battle",price:200,type:"item",itemId:"revive"}
];

const RARITY={
  Common:{bg:"linear-gradient(135deg,#6b7280,#4b5563)",border:"#9ca3af",glow:""},
  Rare:{bg:"linear-gradient(135deg,#3b82f6,#1d4ed8)",border:"#60a5fa",glow:"glow-rare"},
  Epic:{bg:"linear-gradient(135deg,#8b5cf6,#6d28d9)",border:"#a78bfa",glow:"glow-epic"},
  Legendary:{bg:"linear-gradient(135deg,#fbbf24,#d97706)",border:"#fcd34d",glow:"glow-legendary"}
};

const XP_TABLE=[0,100,250,500,800,1200,1700,2300,3000,4000,5200,6500,8000,10000,12500,15500,19000,23000,28000,34000,41000,49000,58000,68000,80000];

// =============== HELPERS ===============
const save=d=>{try{localStorage.setItem('sq2',JSON.stringify(d))}catch(e){}};
const load=()=>{try{const d=localStorage.getItem('sq2');return d?JSON.parse(d):null}catch(e){return null}};
const getLvl=xp=>{for(let i=XP_TABLE.length-1;i>=0;i--)if(xp>=XP_TABLE[i])return i+1;return 1};
const getXpProg=xp=>{const l=getLvl(xp),c=xp-(XP_TABLE[l-1]||0),n=(XP_TABLE[l]||99999)-(XP_TABLE[l-1]||0);return{cur:c,need:n,pct:Math.min(c/n*100,100)}};
const rng=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;

// =============== MAIN APP ===============
function App(){
  const[game,setGame]=useState(()=>load()||{
    screen:"splash",user:null,tutDone:false,
    completed:{},stars:{},
    inv:[],companions:[],items:{potion:0,revive:0},
    eq:{weapon:null,armor:null,boots:null,companion:null},
    gold:0,tickets:3,energy:5,maxEnergy:5,
    towerBest:0,towerRun:null,
    currentRegion:null,currentChapter:null
  });
  
  const[ui,setUi]=useState({
    name:"",cls:null,
    battle:null,quiz:null,
    dmgPopups:[],
    summonResult:null,pulling:false,
    gearDrop:null,levelUp:null,
    showRegion:null,tab:"gear",
    towerEvent:null,towerReward:null
  });

  useEffect(()=>{if(game.user)save(game)},[game]);

  // Calculate total stats from gear + companion + base
  const getStats=useCallback(()=>{
    if(!game.user)return{atk:10,def:5,hp:100,crit:5,spd:10,maxHp:100};
    const base={...game.user.cls.stats};
    const lvl=getLvl(game.user.xp);
    // Level scaling
    base.atk+=Math.floor(lvl*1.5);
    base.def+=Math.floor(lvl*0.8);
    base.hp+=lvl*5;
    base.crit+=Math.floor(lvl*0.3);
    base.spd+=Math.floor(lvl*0.5);
    // Gear
    ['weapon','armor','boots'].forEach(slot=>{
      const g=game.eq[slot];
      if(g?.stats)Object.entries(g.stats).forEach(([k,v])=>base[k]=(base[k]||0)+v);
    });
    // Companion
    const c=game.eq.companion;
    if(c?.stats)Object.entries(c.stats).forEach(([k,v])=>base[k]=(base[k]||0)+v);
    base.maxHp=base.hp;
    return base;
  },[game.user,game.eq]);

  const getPowerScore=useCallback(()=>{
    const s=getStats();
    return Math.floor(s.atk*2+s.def*1.5+s.hp*0.5+s.crit*3+s.spd);
  },[getStats]);

  // =============== SCREENS ===============
  
  // SPLASH
  if(game.screen==="splash")return(
    <div style={{minHeight:'100vh',background:'#000',color:'#fff',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24,position:'relative',overflow:'hidden'}}>
      <div style={{position:'absolute',inset:0,background:'linear-gradient(to bottom,#1e1b4b,#0f0a1f,#000)'}}/>
      <div style={{position:'absolute',top:'20%',left:'50%',transform:'translateX(-50%)',width:300,height:300,background:'radial-gradient(circle,rgba(251,191,36,.2),transparent 70%)',borderRadius:'50%'}} className="aP"/>
      {[...Array(50)].map((_,i)=><div key={i} style={{position:'absolute',width:Math.random()*3+1,height:Math.random()*3+1,background:'#fff',borderRadius:'50%',opacity:Math.random()*.5+.2,left:`${Math.random()*100}%`,top:`${Math.random()*70}%`}} className="aP"/>)}
      <div style={{position:'relative',zIndex:10,textAlign:'center'}} className="aFI">
        <div style={{fontSize:100,marginBottom:20}} className="aF">‚öîÔ∏è</div>
        <h1 style={{fontSize:42,fontWeight:900,marginBottom:8,background:'linear-gradient(90deg,#fde68a,#fbbf24,#f59e0b)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>Scripture Quest</h1>
        <p style={{color:'rgba(255,255,255,.5)',fontSize:16,marginBottom:50}}>Battle Through The Word</p>
        <button className="btn aG" style={{width:'auto',padding:'18px 48px'}} onClick={()=>setGame(g=>({...g,screen:"intro"}))}>Begin Adventure</button>
      </div>
    </div>
  );

  // INTRO
  if(game.screen==="intro")return(
    <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1e1b4b,#000)',color:'#fff',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24}}>
      <div className="aFI" style={{maxWidth:360,textAlign:'center'}}>
        <div style={{fontSize:50,marginBottom:20}}>üìñ‚öîÔ∏è</div>
        <h2 style={{fontSize:26,fontWeight:700,marginBottom:20}}>How It Works</h2>
        <div style={{textAlign:'left',marginBottom:24}}>
          <div style={{display:'flex',gap:12,marginBottom:16,alignItems:'center'}}><span style={{fontSize:28}}>üìñ</span><div><div style={{fontWeight:600,color:'#fbbf24'}}>Read Scripture</div><div style={{color:'rgba(255,255,255,.6)',fontSize:14}}>Study chapters from the Bible</div></div></div>
          <div style={{display:'flex',gap:12,marginBottom:16,alignItems:'center'}}><span style={{fontSize:28}}>‚öîÔ∏è</span><div><div style={{fontWeight:600,color:'#ef4444'}}>Battle Enemies</div><div style={{color:'rgba(255,255,255,.6)',fontSize:14}}>Fight foes with quiz-powered attacks</div></div></div>
          <div style={{display:'flex',gap:12,marginBottom:16,alignItems:'center'}}><span style={{fontSize:28}}>üéí</span><div><div style={{fontWeight:600,color:'#8b5cf6'}}>Collect Gear</div><div style={{color:'rgba(255,255,255,.6)',fontSize:14}}>Equip weapons, armor & companions</div></div></div>
          <div style={{display:'flex',gap:12,alignItems:'center'}}><span style={{fontSize:28}}>üóº</span><div><div style={{fontWeight:600,color:'#3b82f6'}}>Climb the Tower</div><div style={{color:'rgba(255,255,255,.6)',fontSize:14}}>Endless roguelike challenge</div></div></div>
        </div>
        <button className="btn" onClick={()=>setGame(g=>({...g,screen:"name"}))}>Continue</button>
      </div>
    </div>
  );

  // NAME
  if(game.screen==="name")return(
    <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1e1b4b,#000)',color:'#fff',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24}}>
      <div className="aFI" style={{maxWidth:360,width:'100%',textAlign:'center'}}>
        <div style={{fontSize:60,marginBottom:16}}>‚ú®</div>
        <h2 style={{fontSize:26,fontWeight:700,marginBottom:24}}>Name Your Hero</h2>
        <input type="text" value={ui.name} onChange={e=>setUi(u=>({...u,name:e.target.value}))} placeholder="Enter name..." maxLength={12} style={{width:'100%',padding:18,fontSize:20,background:'rgba(255,255,255,.05)',border:'2px solid rgba(255,255,255,.2)',borderRadius:16,color:'#fff',textAlign:'center',outline:'none',marginBottom:24}}/>
        <button className="btn" disabled={ui.name.trim().length<2} onClick={()=>setGame(g=>({...g,screen:"class"}))}>Continue</button>
      </div>
    </div>
  );

  // CLASS SELECT
  if(game.screen==="class")return(
    <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1e1b4b,#000)',color:'#fff',padding:20,overflow:'auto'}}>
      <div className="aFI" style={{maxWidth:420,margin:'0 auto'}}>
        <h2 style={{fontSize:24,fontWeight:700,textAlign:'center',marginBottom:20}}>Choose Your Class</h2>
        <div style={{display:'flex',flexDirection:'column',gap:12,marginBottom:20}}>
          {CLASSES.map(c=>(
            <button key={c.id} onClick={()=>setUi(u=>({...u,cls:c}))} style={{display:'flex',alignItems:'center',gap:14,padding:14,background:ui.cls?.id===c.id?'rgba(251,191,36,.15)':'rgba(255,255,255,.05)',border:ui.cls?.id===c.id?'2px solid #fbbf24':'2px solid rgba(255,255,255,.1)',borderRadius:16,cursor:'pointer',transition:'all .2s'}}>
              <div style={{width:56,height:56,borderRadius:12,background:'linear-gradient(135deg,#1e293b,#0f172a)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:32,border:'2px solid rgba(255,255,255,.1)'}}>{c.char}</div>
              <div style={{flex:1,textAlign:'left'}}>
                <div style={{fontWeight:700,fontSize:17,marginBottom:2}}>{c.name} {c.icon}</div>
                <div style={{fontSize:12,color:'rgba(255,255,255,.5)',marginBottom:4}}>ATK:{c.stats.atk} DEF:{c.stats.def} HP:{c.stats.hp}</div>
                <div style={{fontSize:12,color:'#a78bfa'}}>‚ö° {c.ability.name}: {c.ability.desc}</div>
              </div>
              {ui.cls?.id===c.id&&<div style={{width:24,height:24,borderRadius:'50%',background:'#fbbf24',display:'flex',alignItems:'center',justifyContent:'center',color:'#000',fontWeight:700,fontSize:14}}>‚úì</div>}
            </button>
          ))}
        </div>
        <button className="btn" disabled={!ui.cls} onClick={()=>{
          const startGear=GEAR.slice(0,3);
          setGame(g=>({...g,screen:"tutStart",user:{name:ui.name.trim(),cls:ui.cls,xp:0},inv:startGear,eq:{weapon:startGear[0],armor:startGear[1],boots:startGear[2],companion:null}}));
        }}>Begin as {ui.cls?.name||'...'}</button>
      </div>
    </div>
  );

  // TUTORIAL START
  if(game.screen==="tutStart")return(
    <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1e1b4b,#000)',color:'#fff',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24}}>
      <div className="aFI" style={{maxWidth:360,textAlign:'center'}}>
        <div style={{fontSize:80,marginBottom:16}}>{game.user?.cls?.char}</div>
        <h2 style={{fontSize:26,fontWeight:700,marginBottom:4}}>Welcome, {game.user?.name}!</h2>
        <p style={{color:'#fbbf24',marginBottom:24}}>{game.user?.cls?.name} ‚Ä¢ Power: {getPowerScore()}</p>
        <div className="card" style={{marginBottom:24,textAlign:'left'}}>
          <h3 style={{fontWeight:700,marginBottom:8,color:'#fbbf24'}}>üìñ Your First Quest</h3>
          <p style={{color:'rgba(255,255,255,.7)',fontSize:14,marginBottom:8}}>Read <strong>Genesis 1</strong>, then battle <strong>The Serpent</strong>!</p>
          <p style={{color:'rgba(255,255,255,.5)',fontSize:13}}>Answer quiz questions correctly to deal damage!</p>
        </div>
        <button className="btn" onClick={()=>{setGame(g=>({...g,screen:"read",currentChapter:"gen-1"}))}}>Start Quest ‚öîÔ∏è</button>
      </div>
    </div>
  );

  // READ SCREEN
  if(game.screen==="read"){
    const ch=CHAPTERS[game.currentChapter];
    if(!ch){setGame(g=>({...g,screen:"home"}));return null}
    const enemy=ENEMIES[ch.enemy];
    return(
      <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1a1a2e,#0f0f1a)',color:'#fff'}}>
        <header style={{padding:'12px 16px',borderBottom:'1px solid rgba(255,255,255,.1)',display:'flex',alignItems:'center',justifyContent:'space-between',background:'rgba(0,0,0,.5)',position:'sticky',top:0,zIndex:10}}>
          <button onClick={()=>setGame(g=>({...g,screen:"home"}))} style={{background:'rgba(255,255,255,.1)',border:'none',borderRadius:'50%',width:40,height:40,color:'#fff',fontSize:18,cursor:'pointer'}}>‚Üê</button>
          <div style={{textAlign:'center'}}><div style={{fontWeight:700}}>{ch.book} {ch.ch}</div><div style={{color:'rgba(255,255,255,.5)',fontSize:13}}>{ch.title}</div></div>
          <div style={{width:40}}/>
        </header>
        
        {/* Enemy Preview */}
        <div style={{padding:'16px',background:'linear-gradient(to bottom,rgba(239,68,68,.1),transparent)'}}>
          <div style={{display:'flex',alignItems:'center',gap:12,justifyContent:'center'}}>
            <span style={{fontSize:36}}>{enemy.emoji}</span>
            <div>
              <div style={{fontWeight:700,color:'#ef4444'}}>{enemy.name}</div>
              <div style={{fontSize:12,color:'rgba(255,255,255,.5)'}}>HP: {enemy.hp} ‚Ä¢ ATK: {enemy.atk}{ch.boss?' ‚Ä¢ BOSS':''}</div>
            </div>
          </div>
        </div>

        <main style={{padding:'16px 20px'}}>
          <div className="card" style={{background:'rgba(120,53,15,.08)',border:'1px solid rgba(251,191,36,.15)',marginBottom:20}}>
            {ch.verses.map((v,i)=><p key={i} style={{marginBottom:14,fontSize:17,lineHeight:1.7}}><span style={{display:'inline-flex',width:26,height:26,borderRadius:'50%',background:'rgba(251,191,36,.2)',color:'#fbbf24',fontSize:11,fontWeight:700,alignItems:'center',justifyContent:'center',marginRight:10}}>{i+1}</span>{v}</p>)}
          </div>
          <button className="btn" onClick={()=>{
            const stats=getStats();
            const enemy=ENEMIES[ch.enemy];
            const eHp=ch.boss?Math.floor(enemy.hp*1.5):enemy.hp;
            setUi(u=>({...u,battle:{
              turn:'player',phase:'action',
              playerHp:stats.maxHp,playerMaxHp:stats.maxHp,
              enemyHp:eHp,enemyMaxHp:eHp,
              combo:0,maxCombo:0,
              quizIndex:0,currentQuiz:null,
              enemyPattern:0,
              shielded:false,stunned:false,
              abilityCooldown:0,
              log:[`${enemy.name} appears!`]
            },quiz:null}));
            setGame(g=>({...g,screen:"battle"}));
          }}>
            <span style={{display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>‚öîÔ∏è Enter Battle</span>
          </button>
        </main>
      </div>
    );
  }

  // BATTLE SCREEN
  if(game.screen==="battle"){
    const ch=CHAPTERS[game.currentChapter];
    const enemy=ENEMIES[ch.enemy];
    const b=ui.battle;
    const stats=getStats();
    if(!b)return null;

    // Victory check
    if(b.enemyHp<=0){
      const xpGain=Math.floor(enemy.xp*(1+b.maxCombo*0.1));
      const goldGain=Math.floor(enemy.gold*(1+b.maxCombo*0.05));
      const stars=b.playerHp>b.playerMaxHp*0.7?3:b.playerHp>b.playerMaxHp*0.3?2:1;
      return(
        <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#064e3b,#000)',color:'#fff',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24}}>
          <div className="aSI" style={{textAlign:'center',maxWidth:340}}>
            <div style={{fontSize:72,marginBottom:16}}>üéâ</div>
            <h2 style={{fontSize:28,fontWeight:700,marginBottom:4}}>Victory!</h2>
            <p style={{color:'rgba(255,255,255,.6)',marginBottom:16}}>{enemy.name} defeated</p>
            <div style={{marginBottom:20}}>{[1,2,3].map(s=><span key={s} style={{fontSize:28,color:s<=stars?'#fbbf24':'rgba(255,255,255,.2)'}}>‚≠ê</span>)}</div>
            <div className="card" style={{marginBottom:20}}>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
                <div style={{textAlign:'center'}}><div style={{color:'#fbbf24',fontWeight:700,fontSize:22}}>+{xpGain}</div><div style={{color:'rgba(255,255,255,.5)',fontSize:13}}>XP</div></div>
                <div style={{textAlign:'center'}}><div style={{color:'#fcd34d',fontWeight:700,fontSize:22}}>+{goldGain}</div><div style={{color:'rgba(255,255,255,.5)',fontSize:13}}>Gold</div></div>
              </div>
              <div style={{borderTop:'1px solid rgba(255,255,255,.1)',marginTop:12,paddingTop:12,textAlign:'center'}}>
                <span style={{color:'#f97316'}}>üî• Best Combo: {b.maxCombo}x</span>
              </div>
            </div>
            <button className="btn" onClick={()=>{
              const oldLvl=getLvl(game.user.xp);
              const newXp=game.user.xp+xpGain;
              const newLvl=getLvl(newXp);
              // Gear drop chance
              const dropRoll=Math.random();
              let drop=null;
              if(dropRoll<(ch.boss?0.5:0.25)){
                const tier=ch.boss?(Math.random()<0.3?'Epic':'Rare'):(Math.random()<0.15?'Rare':'Common');
                const pool=GEAR.filter(g=>g.rarity===tier);
                drop=pool[Math.floor(Math.random()*pool.length)];
              }
              setGame(g=>({
                ...g,
                screen:drop?"gearDrop":"home",
                user:{...g.user,xp:newXp},
                gold:g.gold+goldGain,
                completed:{...g.completed,[game.currentChapter]:true},
                stars:{...g.stars,[game.currentChapter]:Math.max(g.stars[game.currentChapter]||0,stars)},
                tutDone:true,
                inv:drop?[...g.inv,drop]:g.inv
              }));
              setUi(u=>({...u,battle:null,gearDrop:drop,levelUp:newLvl>oldLvl?{old:oldLvl,new:newLvl}:null}));
            }}>Continue</button>
          </div>
        </div>
      );
    }

    // Defeat check
    if(b.playerHp<=0){
      return(
        <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#7f1d1d,#000)',color:'#fff',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24}}>
          <div className="aSI" style={{textAlign:'center',maxWidth:340}}>
            <div style={{fontSize:72,marginBottom:16}}>üíÄ</div>
            <h2 style={{fontSize:28,fontWeight:700,marginBottom:4}}>Defeated!</h2>
            <p style={{color:'rgba(255,255,255,.6)',marginBottom:24}}>{enemy.name} was too strong</p>
            {game.items.revive>0?(
              <button className="btn" style={{marginBottom:12,background:'linear-gradient(135deg,#22c55e,#16a34a)'}} onClick={()=>{
                setGame(g=>({...g,items:{...g.items,revive:g.items.revive-1}}));
                setUi(u=>({...u,battle:{...b,playerHp:Math.floor(b.playerMaxHp/2)}}));
              }}>ü™∂ Use Phoenix Down (Revive)</button>
            ):null}
            <button className="btn2" style={{marginBottom:12}} onClick={()=>{
              if(game.energy>0){
                setGame(g=>({...g,energy:g.energy-1,screen:"read"}));
                setUi(u=>({...u,battle:null}));
              }
            }}>üîÑ Retry (-1‚ö°)</button>
            <button className="btn2" onClick={()=>{setGame(g=>({...g,screen:"home",tutDone:true}));setUi(u=>({...u,battle:null}))}}>Return Home</button>
          </div>
        </div>
      );
    }

    // Quiz phase
    if(b.phase==="quiz"){
      const q=ch.quiz[b.quizIndex%ch.quiz.length];
      return(
        <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1a1a2e,#0f0f1a)',color:'#fff',padding:20}}>
          <div style={{maxWidth:500,margin:'0 auto'}}>
            {/* Mini HP bars */}
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:20}}>
              <div style={{flex:1,marginRight:20}}>
                <div style={{fontSize:12,color:'rgba(255,255,255,.6)',marginBottom:4}}>You</div>
                <div style={{height:8,background:'rgba(255,255,255,.1)',borderRadius:10,overflow:'hidden'}}><div style={{height:'100%',width:`${(b.playerHp/b.playerMaxHp)*100}%`,background:'linear-gradient(90deg,#22c55e,#16a34a)',borderRadius:10,transition:'width .3s'}}/></div>
              </div>
              <div style={{flex:1}}>
                <div style={{fontSize:12,color:'rgba(255,255,255,.6)',marginBottom:4,textAlign:'right'}}>{enemy.name}</div>
                <div style={{height:8,background:'rgba(255,255,255,.1)',borderRadius:10,overflow:'hidden'}}><div style={{height:'100%',width:`${(b.enemyHp/b.enemyMaxHp)*100}%`,background:'linear-gradient(90deg,#ef4444,#dc2626)',borderRadius:10,transition:'width .3s'}}/></div>
              </div>
            </div>
            
            {b.combo>0&&<div style={{textAlign:'center',marginBottom:16}}><span style={{background:'linear-gradient(135deg,#f97316,#ea580c)',padding:'6px 16px',borderRadius:20,fontWeight:700,fontSize:14}}>üî• {b.combo}x COMBO!</span></div>}
            
            <div style={{textAlign:'center',marginBottom:24}}>
              <div style={{color:'rgba(255,255,255,.5)',fontSize:13,marginBottom:8}}>Answer to Attack!</div>
              <h2 style={{fontSize:20,fontWeight:600,lineHeight:1.4}}>{q.q}</h2>
            </div>
            
            <div style={{display:'flex',flexDirection:'column',gap:10}}>
              {q.a.map((ans,i)=>(
                <button key={i} onClick={()=>{
                  const correct=i===q.c;
                  const newCombo=correct?b.combo+1:0;
                  let dmg=0;
                  if(correct){
                    dmg=stats.atk+Math.floor(newCombo*2);
                    if(Math.random()*100<stats.crit)dmg=Math.floor(dmg*2);
                  }
                  const newEnemyHp=Math.max(0,b.enemyHp-dmg);
                  setUi(u=>({...u,
                    battle:{...b,
                      phase:'result',
                      combo:newCombo,
                      maxCombo:Math.max(b.maxCombo,newCombo),
                      enemyHp:newEnemyHp,
                      lastResult:{correct,dmg,answer:ans},
                      quizIndex:b.quizIndex+1
                    },
                    dmgPopups:correct?[...u.dmgPopups,{id:Date.now(),val:dmg,x:50,y:30}]:u.dmgPopups
                  }));
                  // Clear popup and advance
                  setTimeout(()=>{
                    setUi(u=>({...u,dmgPopups:[]}));
                    if(newEnemyHp>0){
                      // Enemy turn
                      setTimeout(()=>setUi(u=>({...u,battle:{...u.battle,phase:'enemyTurn'}})),500);
                    }
                  },800);
                }} style={{padding:16,background:'rgba(255,255,255,.05)',border:'2px solid rgba(255,255,255,.15)',borderRadius:14,color:'#fff',fontSize:16,textAlign:'left',cursor:'pointer'}}>
                  {String.fromCharCode(65+i)}. {ans}
                </button>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // Result phase (brief)
    if(b.phase==="result"){
      const r=b.lastResult;
      return(
        <div style={{minHeight:'100vh',background:r.correct?'linear-gradient(to bottom,#064e3b,#0f0f1a)':'linear-gradient(to bottom,#7f1d1d,#0f0f1a)',color:'#fff',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24}}>
          <div className="aSI" style={{textAlign:'center'}}>
            <div style={{fontSize:72,marginBottom:16}}>{r.correct?'üí•':'‚ùå'}</div>
            <h2 style={{fontSize:32,fontWeight:700,marginBottom:8}}>{r.correct?`${r.dmg} Damage!`:'Missed!'}</h2>
            <p style={{color:'rgba(255,255,255,.6)'}}>{r.correct?'Great answer!':'Wrong answer...'}</p>
          </div>
        </div>
      );
    }

    // Enemy turn phase
    if(b.phase==="enemyTurn"){
      const pattern=enemy.pattern[b.enemyPattern%enemy.pattern.length];
      let enemyDmg=0;
      let msg="";
      
      if(b.stunned){
        msg=`${enemy.name} is stunned!`;
      }else if(pattern==="attack"){
        enemyDmg=Math.max(1,enemy.atk-Math.floor(stats.def/2));
        if(b.shielded){enemyDmg=0;msg=`Shield blocked the attack!`}
        else{msg=`${enemy.name} attacks for ${enemyDmg}!`}
      }else if(pattern==="defend"){
        msg=`${enemy.name} is defending...`;
      }else if(pattern==="rage"||pattern==="smash"){
        enemyDmg=Math.max(1,Math.floor(enemy.atk*1.5)-Math.floor(stats.def/2));
        if(b.shielded){enemyDmg=0;msg=`Shield blocked the attack!`}
        else{msg=`${enemy.name} uses ${pattern}! ${enemyDmg} damage!`}
      }else{
        msg=`${enemy.name} prepares...`;
      }

      setTimeout(()=>{
        setUi(u=>({...u,battle:{
          ...u.battle,
          phase:'action',
          playerHp:Math.max(0,u.battle.playerHp-enemyDmg),
          enemyPattern:u.battle.enemyPattern+1,
          shielded:false,
          stunned:false,
          abilityCooldown:Math.max(0,u.battle.abilityCooldown-1),
          log:[...u.battle.log,msg]
        }}));
      },1200);

      return(
        <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#7f1d1d,#0f0f1a)',color:'#fff',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24}}>
          <div className="aShake" style={{fontSize:80,marginBottom:20}}>{enemy.emoji}</div>
          <div style={{fontSize:20,fontWeight:600,textAlign:'center'}}>{msg}</div>
        </div>
      );
    }

    // ACTION PHASE - Main battle UI
    const companion=game.eq.companion;
    const abilityReady=b.abilityCooldown===0;
    
    return(
      <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1a1a2e,#0f0f1a)',color:'#fff',display:'flex',flexDirection:'column'}}>
        {/* Damage popups */}
        {ui.dmgPopups.map(p=><div key={p.id} className="aDmg" style={{position:'fixed',left:`${p.x}%`,top:`${p.y}%`,transform:'translateX(-50%)',color:'#fbbf24',fontSize:32,fontWeight:900,textShadow:'0 2px 10px rgba(0,0,0,.5)',zIndex:100}}>-{p.val}</div>)}
        
        {/* Enemy area */}
        <div style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:20,background:'linear-gradient(to bottom,rgba(239,68,68,.05),transparent)'}}>
          <div style={{marginBottom:8,width:'80%',maxWidth:300}}>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:12,marginBottom:4}}><span style={{color:'#ef4444'}}>{enemy.name}{ch.boss?' üëë':''}</span><span>{b.enemyHp}/{b.enemyMaxHp}</span></div>
            <div style={{height:12,background:'rgba(0,0,0,.5)',borderRadius:10,overflow:'hidden',border:'1px solid rgba(255,255,255,.1)'}}><div style={{height:'100%',width:`${(b.enemyHp/b.enemyMaxHp)*100}%`,background:'linear-gradient(90deg,#ef4444,#dc2626)',borderRadius:10,transition:'width .3s'}}/></div>
          </div>
          <div style={{fontSize:72}} className={b.enemyHp<b.enemyMaxHp*0.3?'aShake':''}>{enemy.emoji}</div>
        </div>
        
        {/* Player area */}
        <div style={{padding:20,background:'rgba(0,0,0,.3)',borderTop:'1px solid rgba(255,255,255,.1)'}}>
          {/* Player HP */}
          <div style={{marginBottom:16}}>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:13,marginBottom:4,alignItems:'center'}}>
              <span style={{display:'flex',alignItems:'center',gap:8}}><span style={{fontSize:24}}>{game.user?.cls?.char}</span>{game.user?.name}</span>
              <span style={{color:'#22c55e'}}>{b.playerHp}/{b.playerMaxHp} HP</span>
            </div>
            <div style={{height:14,background:'rgba(0,0,0,.5)',borderRadius:10,overflow:'hidden',border:'1px solid rgba(255,255,255,.1)'}}><div style={{height:'100%',width:`${(b.playerHp/b.playerMaxHp)*100}%`,background:'linear-gradient(90deg,#22c55e,#16a34a)',borderRadius:10,transition:'width .3s'}}/></div>
          </div>
          
          {/* Action buttons */}
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:12}}>
            <button onClick={()=>setUi(u=>({...u,battle:{...b,phase:'quiz'}}))} style={{padding:16,background:'linear-gradient(135deg,#ef4444,#dc2626)',border:'none',borderRadius:14,color:'#fff',fontWeight:700,fontSize:16,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
              ‚öîÔ∏è Attack
            </button>
            <button onClick={()=>{
              setUi(u=>({...u,battle:{...u.battle,shielded:true,phase:'enemyTurn'}}));
            }} style={{padding:16,background:'linear-gradient(135deg,#3b82f6,#2563eb)',border:'none',borderRadius:14,color:'#fff',fontWeight:700,fontSize:16,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
              üõ°Ô∏è Defend
            </button>
          </div>
          
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
            <button disabled={!abilityReady} onClick={()=>{
              const ab=game.user.cls.ability;
              let newBattle={...b,abilityCooldown:ab.cooldown};
              if(ab.name==="Holy Fire"){
                // Next attack 2x
                newBattle.phase='quiz';
              }else if(ab.name==="Healing Word"){
                newBattle.playerHp=Math.min(b.playerMaxHp,b.playerHp+30);
                newBattle.phase='enemyTurn';
              }else if(ab.name==="Shield of Faith"){
                newBattle.shielded=true;
                newBattle.phase='enemyTurn';
              }else if(ab.name==="Righteous Strike"){
                // Guaranteed crit attack
                newBattle.phase='quiz';
              }
              setUi(u=>({...u,battle:newBattle}));
            }} style={{padding:14,background:abilityReady?'linear-gradient(135deg,#8b5cf6,#7c3aed)':'rgba(139,92,246,.2)',border:'none',borderRadius:14,color:'#fff',fontWeight:600,fontSize:14,cursor:abilityReady?'pointer':'not-allowed',opacity:abilityReady?1:.5}}>
              ‚ö° {game.user?.cls?.ability?.name} {!abilityReady&&`(${b.abilityCooldown})`}
            </button>
            <button disabled={game.items.potion<=0} onClick={()=>{
              setGame(g=>({...g,items:{...g.items,potion:g.items.potion-1}}));
              setUi(u=>({...u,battle:{...b,playerHp:Math.min(b.playerMaxHp,b.playerHp+50),phase:'enemyTurn'}}));
            }} style={{padding:14,background:game.items.potion>0?'linear-gradient(135deg,#22c55e,#16a34a)':'rgba(34,197,94,.2)',border:'none',borderRadius:14,color:'#fff',fontWeight:600,fontSize:14,cursor:game.items.potion>0?'pointer':'not-allowed',opacity:game.items.potion>0?1:.5}}>
              üß™ Potion ({game.items.potion})
            </button>
          </div>
          
          {/* Companion */}
          {companion&&(
            <div style={{marginTop:12,padding:12,background:'rgba(255,255,255,.05)',borderRadius:12,display:'flex',alignItems:'center',gap:12}}>
              <div style={{width:40,height:40,borderRadius:'50%',background:RARITY[companion.rarity].bg,display:'flex',alignItems:'center',justifyContent:'center',fontSize:20}}>{companion.emoji}</div>
              <div style={{flex:1}}><div style={{fontWeight:600,fontSize:13}}>{companion.name}</div><div style={{color:'rgba(255,255,255,.5)',fontSize:11}}>{companion.bonus}</div></div>
            </div>
          )}
        </div>
      </div>
    );
  }

  // GEAR DROP
  if(game.screen==="gearDrop"){
    const gear=ui.gearDrop;
    if(!gear){setGame(g=>({...g,screen:"home"}));return null}
    const r=RARITY[gear.rarity];
    return(
      <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1e1b4b,#000)',color:'#fff',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24}}>
        <div className="aSI" style={{textAlign:'center',maxWidth:320}}>
          <div style={{color:'#fbbf24',fontSize:12,fontWeight:700,letterSpacing:2,marginBottom:16}}>‚öîÔ∏è LOOT DROP! ‚öîÔ∏è</div>
          <div className={r.glow} style={{width:100,height:100,borderRadius:20,background:r.bg,border:`3px solid ${r.border}`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:48,margin:'0 auto 16px'}}>{gear.icon}</div>
          <h2 style={{fontSize:22,fontWeight:700,marginBottom:4}}>{gear.name}</h2>
          <div style={{color:r.border,fontSize:13,marginBottom:8}}>{gear.rarity}</div>
          <div style={{color:'#4ade80',fontSize:15,marginBottom:24}}>{gear.desc}</div>
          <button className="btn" onClick={()=>{setUi(u=>({...u,gearDrop:null}));setGame(g=>({...g,screen:"home"}))}}>Continue</button>
        </div>
      </div>
    );
  }

  // HOME SCREEN
  if(game.screen==="home"){
    const u=game.user;if(!u)return null;
    const lvl=getLvl(u.xp),prog=getXpProg(u.xp),stats=getStats(),power=getPowerScore();
    const completedCount=Object.keys(game.completed).length;
    const totalStars=Object.values(game.stars).reduce((a,b)=>a+b,0);
    
    // Find next chapter
    let nextChapter=null;
    for(const r of REGIONS){
      if(lvl>=r.unlockLvl){
        for(const ch of r.chapters){
          if(!game.completed[ch]){nextChapter=ch;break}
        }
        if(nextChapter)break;
      }
    }
    const nextCh=nextChapter?CHAPTERS[nextChapter]:null;
    
    return(
      <div style={{minHeight:'100vh',background:'#000',color:'#fff',position:'relative',overflow:'hidden'}}>
        <div style={{position:'absolute',inset:0,background:'linear-gradient(to bottom,#1e1b4b,#0f172a 50%,#000)'}}/>
        {[...Array(40)].map((_,i)=><div key={i} style={{position:'absolute',width:Math.random()*2+1,height:Math.random()*2+1,background:'#fff',borderRadius:'50%',opacity:Math.random()*.3+.1,left:`${Math.random()*100}%`,top:`${Math.random()*50}%`}}/>)}
        
        {/* Level up modal */}
        {ui.levelUp&&<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,.95)',zIndex:200,display:'flex',alignItems:'center',justifyContent:'center'}}><div className="aSI" style={{textAlign:'center'}}><div style={{fontSize:80,marginBottom:16}}>‚¨ÜÔ∏è</div><h2 style={{fontSize:36,fontWeight:900,color:'#fbbf24',marginBottom:8}}>LEVEL UP!</h2><p style={{fontSize:24,marginBottom:24}}>Level {ui.levelUp.new}</p><button className="btn" style={{width:'auto',padding:'14px 40px'}} onClick={()=>setUi(u=>({...u,levelUp:null}))}>Awesome!</button></div></div>}
        
        <div style={{position:'relative',zIndex:10}}>
          {/* Header */}
          <header style={{padding:'12px 16px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div style={{display:'flex',gap:8}}>
              <div style={{background:'rgba(251,191,36,.3)',border:'1px solid rgba(251,191,36,.5)',padding:'6px 12px',borderRadius:20,display:'flex',alignItems:'center',gap:6}}><span>ü™ô</span><span style={{fontWeight:700,color:'#fcd34d'}}>{game.gold}</span></div>
            </div>
            <div style={{display:'flex',gap:8}}>
              <div style={{background:'rgba(59,130,246,.3)',border:'1px solid rgba(59,130,246,.5)',padding:'6px 12px',borderRadius:20,display:'flex',alignItems:'center',gap:6}}><span>‚ö°</span><span style={{fontWeight:700,color:'#93c5fd'}}>{game.energy}/{game.maxEnergy}</span></div>
              <div style={{background:'rgba(236,72,153,.3)',border:'1px solid rgba(236,72,153,.5)',padding:'6px 12px',borderRadius:20,display:'flex',alignItems:'center',gap:6}}><span>üéüÔ∏è</span><span style={{fontWeight:700,color:'#f9a8d4'}}>{game.tickets}</span></div>
            </div>
          </header>
          
          {/* Character Card */}
          <div style={{margin:'0 16px 16px',background:'linear-gradient(135deg,rgba(30,41,59,.8),rgba(15,23,42,.8))',border:'1px solid rgba(255,255,255,.1)',borderRadius:20,padding:16}}>
            <div style={{display:'flex',gap:16}}>
              {/* Character visual */}
              <div style={{position:'relative'}}>
                <div style={{width:90,height:90,borderRadius:16,background:'linear-gradient(135deg,#1e293b,#0f172a)',border:'3px solid rgba(251,191,36,.5)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:48}}>
                  {u.cls.char}
                  {game.eq.weapon&&<div style={{position:'absolute',top:-4,right:-4,fontSize:20}}>{game.eq.weapon.icon}</div>}
                  {game.eq.companion&&<div style={{position:'absolute',bottom:-4,left:-4,fontSize:22}}>{game.eq.companion.emoji}</div>}
                </div>
                <div style={{position:'absolute',bottom:-6,left:'50%',transform:'translateX(-50%)',background:'linear-gradient(135deg,#f59e0b,#d97706)',color:'#000',fontWeight:900,fontSize:11,padding:'3px 12px',borderRadius:12}}>Lv.{lvl}</div>
              </div>
              
              {/* Stats */}
              <div style={{flex:1}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
                  <h2 style={{fontSize:18,fontWeight:700}}>{u.name}</h2>
                  <div style={{background:'rgba(139,92,246,.2)',padding:'4px 10px',borderRadius:8,fontSize:12,fontWeight:700,color:'#a78bfa'}}>‚ö°{power}</div>
                </div>
                
                <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:6,fontSize:11}}>
                  <div style={{background:'rgba(239,68,68,.15)',padding:'6px 8px',borderRadius:8,textAlign:'center'}}><div style={{color:'#f87171',fontWeight:700}}>{stats.atk}</div><div style={{color:'rgba(255,255,255,.5)'}}>ATK</div></div>
                  <div style={{background:'rgba(59,130,246,.15)',padding:'6px 8px',borderRadius:8,textAlign:'center'}}><div style={{color:'#60a5fa',fontWeight:700}}>{stats.def}</div><div style={{color:'rgba(255,255,255,.5)'}}>DEF</div></div>
                  <div style={{background:'rgba(34,197,94,.15)',padding:'6px 8px',borderRadius:8,textAlign:'center'}}><div style={{color:'#4ade80',fontWeight:700}}>{stats.maxHp}</div><div style={{color:'rgba(255,255,255,.5)'}}>HP</div></div>
                </div>
                
                <div style={{marginTop:8}}>
                  <div style={{display:'flex',justifyContent:'space-between',fontSize:10,color:'rgba(255,255,255,.5)',marginBottom:3}}><span>XP</span><span>{prog.cur}/{prog.need}</span></div>
                  <div style={{height:6,background:'rgba(0,0,0,.5)',borderRadius:10,overflow:'hidden'}}><div style={{height:'100%',width:`${prog.pct}%`,background:'linear-gradient(90deg,#f59e0b,#fbbf24)',borderRadius:10}}/></div>
                </div>
              </div>
            </div>
          </div>
          
          {/* Main Quest */}
          {nextCh?(
            <div style={{padding:'0 16px',marginBottom:16}}>
              <button onClick={()=>setGame(g=>({...g,screen:"read",currentChapter:nextChapter}))} style={{width:'100%',background:'linear-gradient(135deg,rgba(146,64,14,.5),rgba(120,53,15,.5))',border:'2px solid rgba(251,191,36,.5)',borderRadius:20,padding:16,textAlign:'left',cursor:'pointer'}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                  <div>
                    <div style={{color:'rgba(251,191,36,.8)',fontSize:11,fontWeight:700,letterSpacing:1,marginBottom:4}}>NEXT QUEST</div>
                    <div style={{fontSize:18,fontWeight:700,marginBottom:2}}>{nextCh.book} {nextCh.ch}: {nextCh.title}</div>
                    <div style={{color:'rgba(255,255,255,.5)',fontSize:13,display:'flex',alignItems:'center',gap:8}}>
                      <span>{ENEMIES[nextCh.enemy].emoji} {ENEMIES[nextCh.enemy].name}</span>
                      {nextCh.boss&&<span style={{background:'rgba(239,68,68,.3)',color:'#f87171',padding:'2px 8px',borderRadius:4,fontSize:10,fontWeight:700}}>BOSS</span>}
                    </div>
                  </div>
                  <div style={{fontSize:32}}>‚öîÔ∏è</div>
                </div>
              </button>
            </div>
          ):(
            <div style={{padding:'0 16px',marginBottom:16}}>
              <div className="card" style={{textAlign:'center',padding:24}}>
                <div style={{fontSize:48,marginBottom:8}}>üéâ</div>
                <div style={{fontWeight:700}}>All quests complete!</div>
                <div style={{color:'rgba(255,255,255,.5)',fontSize:13}}>More content coming soon</div>
              </div>
            </div>
          )}
          
          {/* Feature Grid */}
          <div style={{padding:'0 16px',marginBottom:16}}>
            <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10}}>
              {[
                {icon:"üó∫Ô∏è",name:"Campaign",scr:"campaign"},
                {icon:"üóº",name:"Tower",scr:"tower"},
                {icon:"üéí",name:"Gear",scr:"inventory"},
                {icon:"‚ú®",name:"Summon",scr:"summon"}
              ].map(b=>(
                <button key={b.name} onClick={()=>setGame(g=>({...g,screen:b.scr}))} style={{background:'rgba(255,255,255,.05)',border:'1px solid rgba(255,255,255,.1)',borderRadius:14,padding:'14px 8px',display:'flex',flexDirection:'column',alignItems:'center',gap:4,cursor:'pointer'}}>
                  <span style={{fontSize:26}}>{b.icon}</span>
                  <span style={{fontSize:11,color:'rgba(255,255,255,.7)'}}>{b.name}</span>
                </button>
              ))}
            </div>
          </div>
          
          {/* Stats Bar */}
          <div style={{padding:'0 16px',marginBottom:16}}>
            <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:10}}>
              <div className="card" style={{textAlign:'center',padding:12}}>
                <div style={{fontSize:24,fontWeight:700,color:'#fbbf24'}}>{completedCount}</div>
                <div style={{fontSize:11,color:'rgba(255,255,255,.5)'}}>Chapters</div>
              </div>
              <div className="card" style={{textAlign:'center',padding:12}}>
                <div style={{fontSize:24,fontWeight:700,color:'#fbbf24'}}>‚≠ê{totalStars}</div>
                <div style={{fontSize:11,color:'rgba(255,255,255,.5)'}}>Stars</div>
              </div>
              <div className="card" style={{textAlign:'center',padding:12}}>
                <div style={{fontSize:24,fontWeight:700,color:'#a78bfa'}}>{game.towerBest}</div>
                <div style={{fontSize:11,color:'rgba(255,255,255,.5)'}}>Tower</div>
              </div>
            </div>
          </div>
          
          {/* Shop Button */}
          <div style={{padding:'0 16px 24px'}}>
            <button onClick={()=>setGame(g=>({...g,screen:"shop"}))} style={{width:'100%',background:'linear-gradient(135deg,rgba(234,88,12,.3),rgba(220,38,38,.3))',border:'1px solid rgba(249,115,22,.4)',borderRadius:14,padding:14,display:'flex',alignItems:'center',gap:12,cursor:'pointer'}}>
              <span style={{fontSize:28}}>üè™</span>
              <div style={{flex:1,textAlign:'left'}}><div style={{fontWeight:700}}>Shop</div><div style={{color:'rgba(255,255,255,.5)',fontSize:12}}>Buy potions, energy & more</div></div>
              <span style={{color:'rgba(255,255,255,.4)',fontSize:20}}>‚Üí</span>
            </button>
          </div>
        </div>
      </div>
    );
  }

  // CAMPAIGN
  if(game.screen==="campaign"){
    const lvl=getLvl(game.user?.xp||0);
    return(
      <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1e1b4b,#000)',color:'#fff'}}>
        <header style={{padding:16,display:'flex',alignItems:'center',gap:12,borderBottom:'1px solid rgba(255,255,255,.1)'}}>
          <button onClick={()=>setGame(g=>({...g,screen:"home"}))} style={{width:40,height:40,borderRadius:'50%',background:'rgba(255,255,255,.1)',border:'none',color:'#fff',fontSize:18,cursor:'pointer'}}>‚Üê</button>
          <div style={{flex:1,fontWeight:700,fontSize:18}}>Campaign</div>
          <div style={{color:'#fbbf24'}}>‚≠ê{Object.values(game.stars).reduce((a,b)=>a+b,0)}</div>
        </header>
        <div style={{padding:16}}>
          {REGIONS.map(r=>{
            const unlocked=lvl>=r.unlockLvl;
            const stars=r.chapters.reduce((s,c)=>s+(game.stars[c]||0),0);
            const completed=r.chapters.filter(c=>game.completed[c]).length;
            return(
              <button key={r.id} disabled={!unlocked} onClick={()=>unlocked&&setUi(u=>({...u,showRegion:r}))} style={{width:'100%',padding:16,marginBottom:12,background:unlocked?'rgba(251,191,36,.08)':'rgba(255,255,255,.02)',border:unlocked?'2px solid rgba(251,191,36,.3)':'1px solid rgba(255,255,255,.1)',borderRadius:16,display:'flex',alignItems:'center',gap:14,cursor:unlocked?'pointer':'not-allowed',opacity:unlocked?1:.5}}>
                <div style={{width:52,height:52,borderRadius:14,background:'rgba(255,255,255,.1)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:26}}>{unlocked?r.icon:"üîí"}</div>
                <div style={{flex:1,textAlign:'left'}}>
                  <div style={{fontWeight:700,fontSize:16}}>{r.name}</div>
                  {unlocked&&r.chapters.length>0&&<div style={{color:'#fbbf24',fontSize:12}}>‚≠ê{stars}/{r.chapters.length*3} ‚Ä¢ {completed}/{r.chapters.length} done</div>}
                  {!unlocked&&<div style={{color:'rgba(251,191,36,.6)',fontSize:12}}>Unlocks at Lv.{r.unlockLvl}</div>}
                </div>
              </button>
            );
          })}
        </div>
        
        {/* Region modal */}
        {ui.showRegion&&<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,.85)',zIndex:50,display:'flex',alignItems:'flex-end'}} onClick={()=>setUi(u=>({...u,showRegion:null}))}>
          <div style={{background:'linear-gradient(to bottom,#1e293b,#0f172a)',borderRadius:'24px 24px 0 0',padding:20,width:'100%',maxHeight:'75vh',overflow:'auto'}} onClick={e=>e.stopPropagation()}>
            <div style={{display:'flex',alignItems:'center',gap:14,marginBottom:20}}>
              <div style={{width:50,height:50,borderRadius:12,background:'rgba(251,191,36,.2)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:26}}>{ui.showRegion.icon}</div>
              <div><h3 style={{fontSize:20,fontWeight:700}}>{ui.showRegion.name}</h3><div style={{color:'rgba(255,255,255,.5)',fontSize:13}}>{ui.showRegion.chapters.length} Chapters</div></div>
            </div>
            {ui.showRegion.chapters.length===0?<p style={{textAlign:'center',color:'rgba(255,255,255,.4)',padding:'32px 0'}}>Coming soon!</p>:(
              <div style={{display:'flex',flexDirection:'column',gap:10}}>
                {ui.showRegion.chapters.map(cId=>{
                  const ch=CHAPTERS[cId];
                  const done=game.completed[cId];
                  const stars=game.stars[cId]||0;
                  const enemy=ENEMIES[ch.enemy];
                  return(
                    <button key={cId} onClick={()=>{setUi(u=>({...u,showRegion:null}));setGame(g=>({...g,screen:"read",currentChapter:cId}))}} style={{padding:14,borderRadius:14,display:'flex',alignItems:'center',gap:12,cursor:'pointer',background:done?'rgba(34,197,94,.08)':'rgba(255,255,255,.05)',border:done?'1px solid rgba(34,197,94,.3)':'1px solid rgba(255,255,255,.1)'}}>
                      <div style={{width:44,height:44,borderRadius:10,background:'rgba(239,68,68,.15)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:22}}>{enemy.emoji}</div>
                      <div style={{flex:1,textAlign:'left'}}>
                        <div style={{fontWeight:600,marginBottom:2}}>{ch.book} {ch.ch}</div>
                        <div style={{color:'rgba(255,255,255,.5)',fontSize:12,display:'flex',alignItems:'center',gap:6}}>{ch.title}{ch.boss&&<span style={{background:'rgba(239,68,68,.3)',color:'#f87171',padding:'1px 6px',borderRadius:4,fontSize:9,fontWeight:700}}>BOSS</span>}</div>
                      </div>
                      <div>{[1,2,3].map(s=><span key={s} style={{color:s<=stars?'#fbbf24':'rgba(255,255,255,.2)',fontSize:14}}>‚≠ê</span>)}</div>
                    </button>
                  );
                })}
              </div>
            )}
            <button className="btn2" style={{marginTop:16}} onClick={()=>setUi(u=>({...u,showRegion:null}))}>Close</button>
          </div>
        </div>}
      </div>
    );
  }

  // TOWER
  if(game.screen==="tower"){
    const stats=getStats();
    
    // Active tower run
    if(game.towerRun){
      const run=game.towerRun;
      const event=TOWER_EVENTS[run.floor%TOWER_EVENTS.length];
      
      // Tower battle
      if(run.inBattle){
        // Similar to main battle but simplified
        return(
          <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1a1a2e,#0f0f1a)',color:'#fff',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24}}>
            <div style={{textAlign:'center'}}>
              <div style={{fontSize:14,color:'rgba(255,255,255,.5)',marginBottom:8}}>üóº Floor {run.floor}</div>
              <div style={{fontSize:60,marginBottom:16}}>{run.enemy.emoji}</div>
              <div style={{fontWeight:700,marginBottom:24}}>{run.enemy.name}</div>
              <button className="btn" onClick={()=>{
                // Simplified: random win/lose based on power
                const playerPower=getPowerScore();
                const enemyPower=run.enemy.hp+run.enemy.atk*2;
                const winChance=Math.min(0.9,Math.max(0.2,playerPower/(playerPower+enemyPower)));
                
                if(Math.random()<winChance){
                  // Win
                  const newFloor=run.floor+1;
                  const goldReward=20+run.floor*5;
                  setGame(g=>({...g,gold:g.gold+goldReward,towerRun:{...run,floor:newFloor,inBattle:false},towerBest:Math.max(g.towerBest,newFloor)}));
                }else{
                  // Lose - end run
                  setGame(g=>({...g,towerRun:null}));
                }
              }}>‚öîÔ∏è Fight!</button>
              <p style={{marginTop:16,color:'rgba(255,255,255,.5)',fontSize:13}}>Win chance based on Power Score</p>
            </div>
          </div>
        );
      }
      
      return(
        <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1e1b4b,#000)',color:'#fff'}}>
          <header style={{padding:16,display:'flex',alignItems:'center',gap:12,borderBottom:'1px solid rgba(255,255,255,.1)'}}>
            <button onClick={()=>setGame(g=>({...g,screen:"home"}))} style={{width:40,height:40,borderRadius:'50%',background:'rgba(255,255,255,.1)',border:'none',color:'#fff',fontSize:18,cursor:'pointer'}}>‚Üê</button>
            <div style={{flex:1}}><div style={{fontWeight:700,fontSize:18}}>Tower of Faith</div><div style={{color:'#fbbf24',fontSize:13}}>Floor {run.floor}</div></div>
            <button onClick={()=>setGame(g=>({...g,towerRun:null}))} style={{background:'rgba(239,68,68,.2)',border:'1px solid rgba(239,68,68,.4)',borderRadius:8,padding:'6px 12px',color:'#f87171',fontSize:13,cursor:'pointer'}}>Abandon</button>
          </header>
          
          <div style={{padding:24,textAlign:'center'}}>
            <div style={{fontSize:80,marginBottom:16}}>üóº</div>
            <h2 style={{fontSize:24,fontWeight:700,marginBottom:8}}>Floor {run.floor}</h2>
            <p style={{color:'rgba(255,255,255,.6)',marginBottom:24}}>
              {event==="battle"?"An enemy blocks your path!":
               event==="elite"?"A powerful foe appears!":
               event==="treasure"?"You found treasure!":
               event==="rest"?"A safe place to rest.":
               event==="shop"?"A mysterious merchant.":"Continue climbing?"}
            </p>
            
            <button className="btn" onClick={()=>{
              if(event==="battle"||event==="elite"){
                const enemies=Object.values(ENEMIES).filter(e=>!e.boss);
                const enemy=enemies[Math.floor(Math.random()*enemies.length)];
                setGame(g=>({...g,towerRun:{...run,inBattle:true,enemy}}));
              }else if(event==="treasure"){
                const gold=rng(30,80);
                setGame(g=>({...g,gold:g.gold+gold,towerRun:{...run,floor:run.floor+1}}));
              }else if(event==="rest"){
                setGame(g=>({...g,towerRun:{...run,floor:run.floor+1}}));
              }else{
                setGame(g=>({...g,towerRun:{...run,floor:run.floor+1}}));
              }
            }}>{event==="battle"||event==="elite"?"‚öîÔ∏è Battle":event==="treasure"?"üéÅ Open":"‚û°Ô∏è Continue"}</button>
          </div>
        </div>
      );
    }
    
    // Tower entrance
    return(
      <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1e1b4b,#000)',color:'#fff'}}>
        <header style={{padding:16,display:'flex',alignItems:'center',gap:12,borderBottom:'1px solid rgba(255,255,255,.1)'}}>
          <button onClick={()=>setGame(g=>({...g,screen:"home"}))} style={{width:40,height:40,borderRadius:'50%',background:'rgba(255,255,255,.1)',border:'none',color:'#fff',fontSize:18,cursor:'pointer'}}>‚Üê</button>
          <div style={{fontWeight:700,fontSize:18}}>Tower of Faith</div>
        </header>
        <div style={{padding:24,textAlign:'center'}}>
          <div style={{fontSize:100,marginBottom:20}}>üóº</div>
          <h2 style={{fontSize:28,fontWeight:700,marginBottom:8}}>Tower of Faith</h2>
          <p style={{color:'rgba(255,255,255,.6)',marginBottom:8}}>Climb endless floors. Battle enemies. Earn rewards.</p>
          <p style={{color:'#fbbf24',marginBottom:24}}>üèÜ Best: Floor {game.towerBest}</p>
          
          <div className="card" style={{marginBottom:24,textAlign:'left'}}>
            <h3 style={{fontWeight:700,marginBottom:12}}>How it Works</h3>
            <div style={{fontSize:14,color:'rgba(255,255,255,.7)',lineHeight:1.6}}>
              <p style={{marginBottom:8}}>‚öîÔ∏è Battle enemies to progress</p>
              <p style={{marginBottom:8}}>üéÅ Find treasure and rewards</p>
              <p style={{marginBottom:8}}>üíÄ Death ends your run</p>
              <p>‚ö° Power Score affects win chance</p>
            </div>
          </div>
          
          <button className="btn" disabled={game.energy<1} onClick={()=>{
            setGame(g=>({...g,energy:g.energy-1,towerRun:{floor:1,inBattle:false,enemy:null}}));
          }}>Start Run (1‚ö°)</button>
        </div>
      </div>
    );
  }
 style={{color:'#f87171',fontWeight:700}}>{stats.atk}</span><span style={{color:'rgba(255,255,255,.5)',marginLeft:6}}>ATK</span></div>
                <div style={{background:'rgba(59,130,246,.1)',padding:'8px 10px',borderRadius:8}}><span style={{color:'#60a5fa',fontWeight:700}}>{stats.def}</span><span style={{color:'rgba(255,255,255,.5)',marginLeft:6}}>DEF</span></div>
                <div style={{background:'rgba(34,197,94,.1)',padding:'8px 10px',borderRadius:8}}><span style={{color:'#4ade80',fontWeight:700}}>{stats.maxHp}</span><span style={{color:'rgba(255,255,255,.5)',marginLeft:6}}>HP</span></div>
                <div style={{background:'rgba(251,191,36,.1)',padding:'8px 10px',borderRadius:8}}><span style={{color:'#fbbf24',fontWeight:700}}>{stats.crit}%</span><span style={{color:'rgba(255,255,255,.5)',marginLeft:6}}>CRIT</span></div>
              </div>
            </div>
          </div>
          
          {/* Tabs */}
          <div style={{display:'flex',gap:8,marginBottom:16}}>
            <button onClick={()=>setUi(u=>({...u,tab:"gear"}))} style={{flex:1,padding:12,borderRadius:10,fontWeight:600,background:ui.tab==="gear"?'#f59e0b':'rgba(255,255,255,.1)',color:ui.tab==="gear"?'#000':'#fff',border:'none',cursor:'pointer'}}>‚öîÔ∏è Gear</button>
            <button onClick={()=>setUi(u=>({...u,tab:"comp"}))} style={{flex:1,padding:12,borderRadius:10,fontWeight:600,background:ui.tab==="comp"?'#f59e0b':'rgba(255,255,255,.1)',color:ui.tab==="comp"?'#000':'#fff',border:'none',cursor:'pointer'}}>üë• Companions</button>
          </div>
          
          {ui.tab==="gear"&&(
            <div>
              {game.inv.length===0?<p style={{textAlign:'center',color:'rgba(255,255,255,.4)',padding:'32px 0'}}>No gear yet. Complete quests to find loot!</p>:(
                <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10}}>
                  {game.inv.map((item,i)=>{
                    const r=RARITY[item.rarity];
                    const isEq=game.eq[item.slot]?.id===item.id;
                    return(
                      <button key={i} onClick={()=>setGame(g=>({...g,eq:{...g.eq,[item.slot]:isEq?null:item}}))} className={r.glow} style={{aspectRatio:'1',borderRadius:12,background:r.bg,border:isEq?'3px solid #4ade80':`2px solid ${r.border}`,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',cursor:'pointer',position:'relative'}}>
                        <span style={{fontSize:28}}>{item.icon}</span>
                        {isEq&&<div style={{position:'absolute',top:4,right:4,width:16,height:16,borderRadius:'50%',background:'#4ade80',fontSize:10,display:'flex',alignItems:'center',justifyContent:'center',color:'#000',fontWeight:700}}>‚úì</div>}
                      </button>
                    );
                  })}
                </div>
              )}
            </div>
          )}
          
          {ui.tab==="comp"&&(
            <div>
              {game.eq.companion&&(
                <div style={{marginBottom:16,padding:14,background:'rgba(34,197,94,.1)',border:'1px solid rgba(34,197,94,.3)',borderRadius:14,display:'flex',alignItems:'center',gap:12}}>
                  <div className={RARITY[game.eq.companion.rarity].glow} style={{width:48,height:48,borderRadius:'50%',background:RARITY[game.eq.companion.rarity].bg,display:'flex',alignItems:'center',justifyContent:'center',fontSize:24}}>{game.eq.companion.emoji}</div>
                  <div style={{flex:1}}>
                    <div style={{fontWeight:700}}>{game.eq.companion.name}</div>
                    <div style={{color:'#4ade80',fontSize:12}}>{game.eq.companion.bonus}</div>
                    <div style={{color:'rgba(255,255,255,.4)',fontSize:11}}>ATK+{game.eq.companion.stats.atk} DEF+{game.eq.companion.stats.def} HP+{game.eq.companion.stats.hp}</div>
                  </div>
                  <span style={{color:'#4ade80',fontWeight:700}}>ACTIVE</span>
                </div>
              )}
              {game.companions.length===0?<p style={{textAlign:'center',color:'rgba(255,255,255,.4)',padding:'32px 0'}}>No companions yet. Use Summon!</p>:(
                <div style={{display:'flex',flexDirection:'column',gap:10}}>
                  {game.companions.map((c,i)=>{
                    const r=RARITY[c.rarity];
                    const isEq=game.eq.companion?.id===c.id;
                    return(
                      <button key={i} onClick={()=>setGame(g=>({...g,eq:{...g.eq,companion:isEq?null:c}}))} style={{padding:12,borderRadius:12,display:'flex',alignItems:'center',gap:12,cursor:'pointer',background:isEq?'rgba(34,197,94,.1)':'rgba(255,255,255,.05)',border:isEq?'2px solid rgba(34,197,94,.5)':'1px solid rgba(255,255,255,.1)'}}>
                        <div className={r.glow} style={{width:44,height:44,borderRadius:'50%',background:r.bg,display:'flex',alignItems:'center',justifyContent:'center',fontSize:22}}>{c.emoji}</div>
                        <div style={{flex:1,textAlign:'left'}}>
                          <div style={{fontWeight:600,display:'flex',alignItems:'center',gap:6}}>{c.name}<span style={{color:r.border,fontSize:10}}>{c.rarity}</span></div>
                          <div style={{color:'#4ade80',fontSize:12}}>{c.bonus}</div>
                        </div>
                        {isEq&&<span style={{color:'#4ade80',fontSize:18}}>‚úì</span>}
                      </button>
                    );
                  })}
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    );
  }

  // SUMMON
  if(game.screen==="summon"){
    if(ui.summonResult){
      const c=ui.summonResult;
      const r=RARITY[c.rarity];
      return(
        <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1e1b4b,#000)',color:'#fff',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24}}>
          <div className="aSI" style={{textAlign:'center'}}>
            <div className={r.glow} style={{width:120,height:120,borderRadius:'50%',background:r.bg,border:`4px solid ${r.border}`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:60,margin:'0 auto 20px'}}>{c.emoji}</div>
            <div style={{color:r.border,fontSize:12,fontWeight:700,letterSpacing:2,marginBottom:8}}>‚òÖ {c.rarity.toUpperCase()} ‚òÖ</div>
            <h2 style={{fontSize:28,fontWeight:700,marginBottom:4}}>{c.name}</h2>
            <p style={{color:'rgba(255,255,255,.6)',fontSize:14,marginBottom:4}}>{c.bonus}</p>
            <p style={{color:'rgba(255,255,255,.4)',fontSize:12,marginBottom:24}}>ATK+{c.stats.atk} DEF+{c.stats.def} HP+{c.stats.hp}</p>
            <button className="btn" onClick={()=>{setGame(g=>({...g,companions:[...g.companions,c]}));setUi(u=>({...u,summonResult:null}))}}>Continue</button>
          </div>
        </div>
      );
    }
    
    if(ui.pulling)return<div style={{minHeight:'100vh',background:'#000',display:'flex',alignItems:'center',justifyContent:'center'}}><div style={{width:80,height:80,borderRadius:'50%',border:'4px solid #8b5cf6',borderTopColor:'transparent'}} className="aS"/></div>;
    
    return(
      <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1e1b4b,#000)',color:'#fff'}}>
        <header style={{padding:16,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
          <button onClick={()=>setGame(g=>({...g,screen:"home"}))} style={{width:40,height:40,borderRadius:'50%',background:'rgba(255,255,255,.1)',border:'none',color:'#fff',fontSize:18,cursor:'pointer'}}>‚Üê</button>
          <div style={{fontWeight:700,fontSize:18}}>Summon</div>
          <div style={{background:'rgba(236,72,153,.2)',padding:'6px 12px',borderRadius:20}}>üéüÔ∏è {game.tickets}</div>
        </header>
        
        <div style={{padding:32,display:'flex',flexDirection:'column',alignItems:'center'}}>
          <div style={{position:'relative',width:140,height:140,marginBottom:32}}>
            <div style={{position:'absolute',inset:0,borderRadius:'50%',border:'3px solid rgba(139,92,246,.3)'}} className="aS"/>
            <div style={{position:'absolute',inset:20,borderRadius:'50%',background:'rgba(139,92,246,.15)',filter:'blur(15px)'}}/>
            <div style={{position:'absolute',inset:30,borderRadius:'50%',background:'linear-gradient(135deg,#581c87,#7c3aed)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:48}}>‚ú®</div>
          </div>
          
          <button className="btn" disabled={game.tickets<1} style={{background:'linear-gradient(135deg,#ec4899,#8b5cf6)',marginBottom:24}} onClick={()=>{
            setUi(u=>({...u,pulling:true}));
            setTimeout(()=>{
              const roll=Math.random();
              const tier=roll<0.03?'Legendary':roll<0.15?'Epic':'Rare';
              const pool=COMPANIONS.filter(c=>c.rarity===tier);
              const result=pool[Math.floor(Math.random()*pool.length)];
              setGame(g=>({...g,tickets:g.tickets-1}));
              setUi(u=>({...u,pulling:false,summonResult:result}));
            },1500);
          }}>Summon √ó1</button>
          
          <div style={{display:'flex',gap:20}}>
            <div style={{textAlign:'center'}}><div style={{color:'#fbbf24',fontWeight:700}}>3%</div><div style={{fontSize:11,color:'rgba(255,255,255,.5)'}}>Legendary</div></div>
            <div style={{textAlign:'center'}}><div style={{color:'#a78bfa',fontWeight:700}}>12%</div><div style={{fontSize:11,color:'rgba(255,255,255,.5)'}}>Epic</div></div>
            <div style={{textAlign:'center'}}><div style={{color:'#60a5fa',fontWeight:700}}>85%</div><div style={{fontSize:11,color:'rgba(255,255,255,.5)'}}>Rare</div></div>
          </div>
        </div>
      </div>
    );
  }

  // SHOP
  if(game.screen==="shop"){
    return(
      <div style={{minHeight:'100vh',background:'linear-gradient(to bottom,#1e1b4b,#000)',color:'#fff'}}>
        <header style={{padding:16,display:'flex',alignItems:'center',justifyContent:'space-between',borderBottom:'1px solid rgba(255,255,255,.1)'}}>
          <button onClick={()=>setGame(g=>({...g,screen:"home"}))} style={{width:40,height:40,borderRadius:'50%',background:'rgba(255,255,255,.1)',border:'none',color:'#fff',fontSize:18,cursor:'pointer'}}>‚Üê</button>
          <div style={{fontWeight:700,fontSize:18}}>Shop</div>
          <div style={{background:'rgba(251,191,36,.2)',padding:'6px 12px',borderRadius:20,color:'#fbbf24'}}>ü™ô {game.gold}</div>
        </header>
        
        <div style={{padding:16}}>
          {SHOP.map(item=>{
            const canBuy=game.gold>=item.price;
            return(
              <button key={item.id} disabled={!canBuy} onClick={()=>{
                if(!canBuy)return;
                let updates={gold:game.gold-item.price};
                if(item.type==="energy")updates.energy=game.maxEnergy;
                if(item.type==="ticket")updates.tickets=game.tickets+1;
                if(item.type==="item")updates.items={...game.items,[item.itemId]:game.items[item.itemId]+1};
                setGame(g=>({...g,...updates}));
              }} style={{width:'100%',padding:16,marginBottom:12,borderRadius:14,display:'flex',alignItems:'center',gap:14,cursor:canBuy?'pointer':'not-allowed',background:'rgba(255,255,255,.05)',border:'1px solid rgba(255,255,255,.1)',opacity:canBuy?1:.5}}>
                <div style={{width:52,height:52,borderRadius:12,background:'linear-gradient(135deg,rgba(251,191,36,.15),rgba(249,115,22,.15))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:26}}>{item.icon}</div>
                <div style={{flex:1,textAlign:'left'}}>
                  <div style={{fontWeight:700}}>{item.name}</div>
                  <div style={{color:'rgba(255,255,255,.5)',fontSize:13}}>{item.desc}</div>
                </div>
                <div style={{color:'#fbbf24',fontWeight:700}}>ü™ô{item.price}</div>
              </button>
            );
          })}
          
          <div style={{marginTop:24,padding:16,background:'rgba(255,255,255,.03)',borderRadius:14}}>
            <h3 style={{fontWeight:700,marginBottom:12}}>Your Items</h3>
            <div style={{display:'flex',gap:12}}>
              <div style={{flex:1,textAlign:'center',padding:12,background:'rgba(255,255,255,.05)',borderRadius:10}}>
                <div style={{fontSize:24}}>üß™</div>
                <div style={{fontWeight:700}}>{game.items.potion}</div>
                <div style={{fontSize:11,color:'rgba(255,255,255,.5)'}}>Potions</div>
              </div>
              <div style={{flex:1,textAlign:'center',padding:12,background:'rgba(255,255,255,.05)',borderRadius:10}}>
                <div style={{fontSize:24}}>ü™∂</div>
                <div style={{fontWeight:700}}>{game.items.revive}</div>
                <div style={{fontSize:11,color:'rgba(255,255,255,.5)'}}>Revives</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Fallback
  return(
    <div style={{minHeight:'100vh',background:'#000',color:'#fff',display:'flex',alignItems:'center',justifyContent:'center'}}>
      <button className="btn" onClick={()=>setGame(g=>({...g,screen:"home"}))}>Go Home</button>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
